{% extends "admindivisions/base.html" %}

{% block content %}
{% load static %}

<div id="map"></div>
<div class="wrapper">
    <nav id="sidebar">
        <div class="sidebar-search text-center">
            <a href="#"><img alt="Rechercher" src="{% static 'search-icon.png' %}" style="width: 40px; border: 1px solid #000; box-sizing: border-box; border-radius: 3px; padding:10px; margin-top:10px"></img></a>
        </div>
        <ul class="list-unstyled components text-center">
            <li><button value="equipement-menu" onclick="openNav(this)" class="sidebutton"><span class="sidebuttonimg"><img alt="Offre et lieux culturels" src="{% static 'equipements.png' %}" style="width: 35px; margin-top:30px;"/></span>
                <span class="sidebuttoninfo"><img alt="Offre et lieux culturels" src="{% static 'equipements.png' %}" style="width: 35px;" /><span class ='sidebuttontxt'>Offre et lieux culturels</span></span>
            </button></li>

            <li><button value="politiques-menu" onclick="openNav(this)" class="sidebutton"><span class="sidebuttonimg"><img alt="Politiques publiques culturelles" src="{% static 'politiques.png' %}" style="width: 35px; margin-top:30px"/></span>
                <span class="sidebuttoninfo"><img alt="Politiques publiques culturelles" src="{% static 'politiques.png' %}" style="width: 35px;" /><span class ='sidebuttontxt'>Politiques publiques culturelles</span></span>
            </button></li>

            <li><button value="depenses-menu" onclick="openNav(this)" class="sidebutton"><span class="sidebuttonimg"><img alt="Dépénses publiques culturelles" src="{% static 'depenses.png' %}" style="width: 35px; margin-top:30px"/></span>
                <span class="sidebuttoninfo"><img alt="Dépénses publiques culturelles" src="{% static 'depenses.png' %}" style="width: 35px;" /><span class ='sidebuttontxt'>Dépénses publiques culturelles</span></span>
            </button></li>

            <li><button value="entreprises-menu" onclick="openNav(this)" class="sidebutton"><span class="sidebuttonimg"><img alt="Entreprises et emploi culturels" src="{% static 'entreprises.png' %}" style="width: 35px; margin-top:30px"/></span>
                <span class="sidebuttoninfo"><img alt="Entreprises et emploi culturels" src="{% static 'entreprises.png' %}" style="width: 35px;" /><span class ='sidebuttontxt'>Entreprises et emploi culturels</span></span>
            </button></li>

            <li><button value="contexte-menu" onclick="openNav(this)" class="sidebutton"><span class="sidebuttonimg"><img alt="Données de contexte" src="{% static 'contexte.png' %}" style="width: 35px; margin-top:30px"/></span>
                <span class="sidebuttoninfo"><img alt="Données de contexte" src="{% static 'contexte.png' %}" style="width: 35px;" /><span class ='sidebuttontxt'>Données de contexte</span></span>
            </button></li>
        </ul>
    </nav>
</div>   

<div id="equipement-menu" class="submenu">
    <button href="javascript:void(0)" value="equipement-menu" class="closebtn" onclick="closeNav(this)">×</button>
    <p class="title">Offre et lieux culturels</p>
    <div class="item">
        {% for domaine in domaines%}
            <p class="subtitle">{{ domaine.name }}</p>
            {% for equipement_type in domaine.equipementtype_set.all %}
            <button class="btn-tag" value="{{ equipement_type.pk }}" onclick="showLayer(this)">{{ equipement_type.name }}</button>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<div id="contexte-menu" class="submenu">
    <button href="javascript:void(0)" value="contexte-menu" class="closebtn" onclick="closeNav(this)">×</button>
    <p class="title">Données de contexte</p>
    <div class="item">
        <p class="subtitle">Population</p>
        <button class="btn-tag" value="Population" onclick="showLayer(this)">Population totale</button>
        <button class="btn-tag" value="Indice de jeunesse" onclick="showLayer(this)">Indice de jeunesse</button>
        <button class="btn-tag" value="Densité de la population" onclick="showLayer(this)">Densité de la population</button>
        <button class="btn-tag" value="Évolution de la population" onclick="showLayer(this)">Évolution de la population</button>
        <p class="subtitle" style="display: none;">Structure de la population par âge</p>
        <p class="subtitle">Niveaux de vie et redistribution</p>
        <button class="btn-tag" value="Niveau de vie médian" onclick="showLayer(this)">Niveau de vie médian</button>
        <button class="btn-tag" value="Taux de pauvreté" style="display: none;" onclick="showLayer(this)">Taux de pauvreté</button>
        <button class="btn-tag" value="Part des ménages fiscaux imposés " style="display: none;" onclick="showLayer(this)">Part des ménages fiscaux imposés</button>
        <p class="subtitle">Politiques publiques</p>
        <button class="btn-tag" value="Action coeur de ville" onclick="showLayer(this)">Action coeur de ville</button>
        <p class="subtitle">Zonage d'études</p>
        <button class="btn-tag" value="Zonage rural" onclick="showLayer(this)">Zonage rural</button>

    </div>
  </div>

<script>
    function openNav(itemMenu) {
      document.getElementById(itemMenu.value).style.width = "419px";
    }
    
    function closeNav(itemMenu) {
      document.getElementById(itemMenu.value).style.width = "0";
    }

    mapboxgl.accessToken = 'pk.eyJ1IjoibGl2aWFyaWJlaXJvIiwiYSI6ImNraTRuOTFlNDBjNTIzMW1od3FhdTh0em8ifQ.TM5OGqVV7cV2IWdq_ZMb3A';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v10',
        center: [4.079306, 48.293024],
        minZoom: 3,
        zoom: 5
    });

    map.addControl(new mapboxgl.NavigationControl(),'bottom-right');

    map.addControl(new MapboxLanguage({
        defaultLanguage: 'fr'
    }));

    var popup = new mapboxgl.Popup({
            closeButton: false
    });

    var zoomThreshold = 6;
    var zoomComThreshold = 9;
    var hoveredStateId = null;

    map.on('load', function () {

        map.getStyle().layers.map(function (layer) {
            if (layer.id.indexOf('road') >= 0) {
            map.setLayoutProperty(layer.id, 'visibility', 'none');
            }
        });
        
        {% for domaine in domaines %}
            {% for equipement_type in domaine.equipementtype_set.all %}
            map.addSource('equipements'+'{{ equipement_type.pk }}', {
                'type': 'geojson',
                'data': "{% url 'equipements' equipement_type.pk %}",
            });
        
            map.addLayer({
                'id': '{{ equipement_type.pk}}',
                'type': 'circle',
                'source': 'equipements'+'{{ equipement_type.pk }}',
                'paint': {
                    'circle-color': '#ff5500',
                    'circle-radius': {
                        stops: [[6, 1.5], [9, 5], [16, 10]]
                    }          
                },            
                'layout': {
                        'visibility': 'none',
                    },      
            });
        
            map.on('click', '{{ equipement_type.pk }}', function (e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var name = e.features[0].properties.nom;
                var adresse = e.features[0].properties.adresse;
                var typology = '{{ equipement_type.name }}';
                
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }               
                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML('<p><i>'+typology+'</i></p>'+
                    '<p><b>'+name+'</b></p>'+ 
                    '<p>'+adresse+'</p>'
                )
                .addTo(map);
            });
            {% endfor %}
        {% endfor %}
        
        function addZoneLayer(zoneLayer, zoneLayerURL, zoneSourceLayer, maxZoom, minZoom) {
            
            var zoneLayerID = zoneLayer + 'Layer';

            map.addSource(zoneLayer, {
                'type': 'vector',
                'url': zoneLayerURL
            });
            
            map.addLayer(
                {
                    'id': zoneLayerID,
                    'source': zoneLayer,
                    'source-layer': zoneSourceLayer,
                    'minzoom': minZoom,
                    'maxzoom': maxZoom,
                    'type': 'fill',
                    'paint': {
                        'fill-color': "#627BC1",
                        'fill-opacity': [
                            'case',
                            ['boolean', ['feature-state', 'hover'], false],
                            0.25,
                            0
                            ]
                    },
                    'layout': {
                        'visibility': 'visible'
                    }
                }  
            );

            map.on('click', zoneLayerID, function (e) {
                var polygon = e.features[0].geometry.coordinates;
                var fit = new L.Polygon(polygon).getBounds();
                var southWest = new mapboxgl.LngLat(fit['_southWest']['lat'], fit['_southWest']['lng']);
                var northEast = new mapboxgl.LngLat(fit['_northEast']['lat'], fit['_northEast']['lng']);
                var center = new mapboxgl.LngLatBounds(southWest, northEast).getCenter();
                console.log(fit)
                map.flyTo({
                    center: center, zoom:maxZoom+1
                });
            });

            map.on('mousemove', zoneLayerID, function (e) {
                if (e.features.length > 0) {
                    if (hoveredStateId) {
                        map.setFeatureState(
                        { source: zoneLayer, sourceLayer: zoneSourceLayer, id: hoveredStateId },
                            { hover: false }
                        );
                    }

                    hoveredStateId = e.features[0].id;

                    map.setFeatureState(
                        { source: zoneLayer, sourceLayer: zoneSourceLayer, id: hoveredStateId },
                        { hover: true }
                        );
                    }
            });

            map.on('mouseleave', zoneLayerID, function () {
                if (hoveredStateId) {
                    map.setFeatureState(
                        { source: zoneLayer, sourceLayer: zoneSourceLayer, id: hoveredStateId },
                        { hover: false }
                        );
                    }
                    hoveredStateId = null;
                });
        }

        var regionLayer = "region";
        var regionURL = 'mapbox://liviaribeiro.3qf6fysf';
        var regionSourceLayer = 'REGION_SIMPLIFIED';
        var regionMaxZoom = zoomThreshold;
        var regionMinZoom = 4;
        var departementLayer = "departement";
        var departementURL = 'mapbox://liviaribeiro.76ba45w7';
        var departementSourceLayer = 'DEPARTEMENT_SIMPLIFIED';
        var departementMaxZoom = zoomComThreshold;
        var departementMinZoom = zoomThreshold;
        var communeLayer = "commune";
        var communeURL = 'mapbox://liviaribeiro.1d5mkyd4';
        var communeSourceLayer = 'COMMUNE_SIMPLIFIED';
        var communeMaxZoom = 12;
        var communeMinZoom = zoomComThreshold;

        addZoneLayer(regionLayer, regionURL, regionSourceLayer, regionMaxZoom, regionMinZoom);
        addZoneLayer(departementLayer, departementURL, departementSourceLayer, departementMaxZoom, departementMinZoom);
        addZoneLayer(communeLayer, communeURL, communeSourceLayer, communeMaxZoom, communeMinZoom);

        map.addSource('population', {
            'type': 'vector',
            'url': 'mapbox://liviaribeiro.1n6485zf'
        });

        map.addLayer(
            {
            'id': 'Population',
            'type': 'circle',
            'source': 'population',
            'source-layer': 'COMMUNE_CARTO_POINTS_CADRAGE-6p2apo',
            'paint': {
                'circle-radius': ['*', 30, ['/',['sqrt', ["get", "POPULATION"]],['sqrt', 2187526]]],
                'circle-color': "hsla(0, 71%, 68%, 0.5)"
                },
                'layout': {
                    // make layer not visible by default
                    'visibility': 'none'
                }
        });

        map.addSource('cadrage', {
            'type': 'vector',
            'url': 'mapbox://liviaribeiro.13vs779l'
        });

        map.addLayer(
            {
                'id': 'Indice de jeunesse',
                'source': 'cadrage',
                'source-layer': 'COMMUNE_CADRAGE_SIMPLIFIED',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        "step",
                        ["get", "INDICEJEUNESSE17"],
                        "#FFFFFF",
                        0,
                        "#FEF3CF",
                        50,
                        "#FDCF41",
                        80,
                        "#FEF3CF",
                        100,
                        "#F79142",
                        150,
                        "#E10600",
                        ],
                    'fill-opacity': 0.75,
                    
                },
                'layout': {
                    // make layer not visible by default
                    'visibility': 'none'
                }
            }
        );  

        map.on('mousemove', 'Indice de jeunesse', function (e) {
            if (e.features.length > 0) {
                popup.setLngLat(e.lngLat)
                    .setHTML('<p>'+e.features[0].properties.NOM_COM+'</p><p>Indice de jeunesse : '
                        +(e.features[0].properties.INDICEJEUNESSE17).toFixed(0)+ '</p>')
                    .addTo(map);
                }     
        });
        
        map.on('mouseleave', 'Indice de jeunesse', function () {
            popup.remove();
        });

        map.addLayer(
            {
                'id': 'Densité de la population',
                'source': 'cadrage',
                'source-layer': 'COMMUNE_CADRAGE_SIMPLIFIED',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        "step",
                        ["get", "DENSITE17"],
                        "hsl(207, 66%, 98%)",
                        50,
                        "#c8e0f4",
                        100,
                        "hsl(207, 64%, 70%)",
                        1000,
                        "hsl(207, 63%, 44%)",
                        10000,
                        "hsl(207, 66%, 23%)"
                        ],
                    'fill-opacity': 0.75,
                },
                'layout': {
                    // make layer not visible by default
                    'visibility': 'none'
                }
            }  
        );    

        map.on('mousemove', 'Densité de la population', function (e) {
            if (e.features.length > 0) {
                popup.setLngLat(e.lngLat)
                    .setHTML('<p>'+e.features[0].properties.NOM_COM+'</p><p>'
                        +(e.features[0].properties.DENSITE17).toFixed(2)+' habitants/km2 </p>')
                    .addTo(map);
                }     
        });
        
        map.on('mouseleave', 'Densité de la population', function () {
            popup.remove();
        });

        map.addLayer(
            {
                'id': 'Évolution de la population',
                'source': 'cadrage',
                'source-layer': 'COMMUNE_CADRAGE_SIMPLIFIED',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        "step",
                        [
                            "get",
                            "TYPOLOGIEEVOL1217"
                        ],
                        "hsl(240, 0%, 63%)",
                        1,
                        "hsl(0, 85%, 51%)",
                        2,
                        "#f674b1",
                        3,
                        "#fcb0d4",
                        4,
                        "hsl(207, 96%, 78%)",
                        5,
                        "hsl(207, 68%, 52%)",
                        6,
                        "#143f61"
                        ],
                },
                'layout': {
                    // make layer not visible by default
                    'visibility': 'none'
                }
            }  
        );      
        
        map.on('mousemove', 'Évolution de la population', function (e) {
            if (e.features.length > 0) {
                popup.setLngLat(e.lngLat)
                    .setHTML('<p>'+e.features[0].properties.NOM_COM+'</p><p>'
                        +(e.features[0].properties.TYPOLOGIEEVOL1217)+'</p>')
                    .addTo(map);
                }     
        });
        
        map.on('mouseleave', 'Évolution de la population', function () {
            popup.remove();
        });

        map.addLayer(
            {
                'id': 'Niveau de vie médian',
                'source': 'cadrage',
                'source-layer': 'COMMUNE_CADRAGE_SIMPLIFIED',
                'type': 'fill',
                'paint': {
                    'fill-color': [
                        "step",
                        ["get", "NIVEAUDEVIE17"],
                        "#FFFFFF",
                        0,
                        "hsl(207, 66%, 98%)",
                        20000,
                        "#c8e0f4",
                        24000,
                        "hsl(207, 64%, 70%)",
                        28000,
                        "hsl(207, 63%, 44%)",
                        34000,
                        "hsl(207, 66%, 23%)"
                        ],
                    'fill-opacity': 0.75,
                    
                },
                'layout': {
                    // make layer not visible by default
                    'visibility': 'none'
                }
            }  
        );    

        map.on('mousemove', 'Niveau de vie médian', function (e) {
            if (e.features.length > 0) {
                popup.setLngLat(e.lngLat)
                    .setHTML('<p>'+e.features[0].properties.NOM_COM+'</p><p>'
                        +(e.features[0].properties.NIVEAUDEVIE17)+' euros </p>')
                    .addTo(map);
                }     
        });
        
        map.on('mouseleave', 'Niveau de vie médian', function () {
            popup.remove();
        });

        map.loadImage(
            'https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png',
            function (error, image) {
            if (error) throw error;
            map.addImage('custom-marker', image);})

        map.addSource('acv', {
            'type': 'vector',
            'url': 'mapbox://liviaribeiro.2f6ii8rh',
            'cluster': true,
            'clusterMaxZoom': 14, // Max zoom to cluster points on
            'clusterRadius': 50 
        });
        
        map.addLayer({
            'id': 'Action coeur de ville',
            'type': 'symbol',
            'source': 'acv',
            'source-layer': 'COMMUNE_CARTO_ACV-834rrb',
            'layout': {
            'icon-image': [
                "case",
                [
                    "match",
                    ["get", "ACV"],
                    ["000000"],
                    false,
                    true
                ],
                "custom-marker",
                ""
                ],
            'icon-size': 0.5,
            'visibility': 'none',
            'icon-allow-overlap': true
            },
        });

        map.on('click', "Action coeur de ville", function (e) {
            new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(e.features[0].properties.NOM_COM)
            .addTo(map);
        });

        map.addSource('zonage rural', {
            'type': 'vector',
            'url': 'mapbox://liviaribeiro.32c0jrtl'
        });
        
        //add zonage rural layer
        map.addLayer(
            {
                'id': 'Zonage rural',
                'source': 'zonage rural',
                'source-layer': 'COMMUNE_CARTO_RURAL_SIMPLE-7gdwr0',
                'type': 'fill',
                'paint': {
                    'fill-color':[
                        "step",
                        ["get", "ZONAGE_RURAL"],        
                        "#ff3d3d",
                        1.1,
                        "#f9a4c9",
                        2.1,
                        '#a9fc92',
                        3.1,
                        "#528603",
                        4,
                        "#528603"
                        ],'fill-opacity': 0.75
                },
                'layout': {
                    // make layer visible by default
                    'visibility': 'none'
                }
            }  
        );

    });


    function showLayer(layer) {
        var visibility = map.getLayoutProperty(layer.value, 'visibility');
        if (visibility == 'none') {
            layer.className += ' active';
            map.setLayoutProperty(layer.value, 'visibility', 'visible');
        }
        if (visibility == 'visible') {
            layer.className = layer.className.replace(/\bactive\b/g, "");
            map.setLayoutProperty(layer.value, 'visibility', 'none');
        }
    }

</script>

<script src="{% static 'contexte.js' %}"></script>-->

<!--<script src="{% static 'map.js' %}"></script>-->


 {% endblock content %}